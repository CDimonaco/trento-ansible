# Trento Ansible

**THIS IS NOT PRODUCTION READY, HIGHLY WIP, USE AT OWN RISK**

**THE PLAYBOOK ASSUMES YOU ARE ON AN OPENSUSE LEAP 15.3**

This playbook aims to install Trento components and the belonging third parties.

## Components

- [web](https://github.com/trento-project/web)
- [wanda](https://github.com/trento-project/wanda)
- postgresql
- rabbitmq
- grafana
- prometheus (WIP)
- nginx



The third parties are installed using `zypper` packages and configured with dedicated roles.

`web` and `wanda` components are installed using containers with the rolling images.

The nginx configuration acts as a reverse proxy for all the components.

## Playbook variables

### Required Variables

| Name         | Description    |
|--------------|-----------|
| web_postgres_password | Password of the postgres user used in web project |
| wanda_postgres_password      | Password of the postgres user used in wanda project |
| rabbitmq_password | Password of the rabbitmq user configured for the trento projects |
| prometheus_url | Base url of prometheus database |
| web_admin_password | Password of the admin user of the web application |
| trento_server_name | Server name of the trento web application, used by nginx |

### Optional variables
These variables are the defaults of our roles, if you want to override the proper roles variables, feel free to inspect them in the playbook code, under the vars folder in each role.

**We recommend to not change** them unless you are sure of what are you doing in your setup.

| Name         | Description    | Default |
|--------------|-----------| --------- |
| web_postgres_db | Name of the postgres database of the web application | webdb |
| web_postgres_event_store | Name of the postgres event store database of web application | event_store |
| web_postgres_user | Name of the postgres user used by web application | web |
| wanda_postgres_user | Name of the postgres user used by wanda project | wanda |
| wanda_postgres_db | Name of the postgres database of wanda application | wanda |
| rabbitmq_username | Username of rabbitmq user, this will be created by the rabbitmq role | trento |
| grafana_public_url | Base url of grafana application | /grafana |
| secret_key_base | The secret of phoenix application | Generated by playbook |
| access_token_secret | The secret used for access tokens jwt signature | Generated by playbook |
| refresh_token_secret | The secret used for refresh tokens jwt signature | Generated by playbook |
| web_admin_username | Username of the admin user in web application | admin |
| enable_alerting | Enable the alerting mechanism on web project | false |
| grafana_sub_path | The subpath of the grafana application | /grafana |
| grafana_api_url | Base API endpoint of grafana, used for dashboard and datasources provision, the defaults assumes you are installing grafana on the same host of the docker container, using the defaults of this playbook | http://host.docker.internal:3000/api |
| install_nginx | Install nginx | true |
| override_nginx_default_conf | Override the default nginx configuration, this will delete the default nginx page and put a configuration that will use the vhosts according to an opinionated directory structure | true |

## Usage with vagrant

You can test the playbook using vagrant, the default configuration in this repository assumes that you have VirtualBox, change it to what matches your setup.

The `Vagrantfile` contains sane defaults for running the playbook, you can find the application running on `localhost:8080` or `trento.local:8080` if you have `trento.local` as `localhost` alias in your `/etc/hosts`.

Start the vagrant box

```bash
$ vagrant up
```

This will spawn a vagrant box with `Opensuse Leap 15.3` as base box. The provisioning will be automatic after the box starts.

Force provision the vagrant box

```bash
$ vagrant provision
```

Use this command when you want to reprovision (re-run the ansible playbook) the vagrant box, you could use this to rerun the playbook if you are in the development process or you want to change some variables.

## TODO

- [ ] Roles with more granular options
- [ ] Task tagging
- [ ] More examples
- [ ] Add prometheus
- [ ] Proper configure the alerting
- [ ] Pipeline
- More..